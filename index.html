<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>WebRTC</title>
</head>
<body>

  <h1>WebRTC Simple Example for Absolute Beginners</h1>

  <video class="remoteVideo" autoplay playsinline></video>
  <video class="localVideo" autoplay playsinline muted></video>

  <script src="/socket.io/socket.io.js"></script>

  <script>

    const config = {
      iceServers: [{
        'urls': ['stun:stun.l.google.com:19302']
      }]
    };

    const socket = io.connect(window.location.origin);

    const remoteVideo = document.querySelector('.remoteVideo');
    const localVideo = document.querySelector('.localVideo');

    // The same for both browser A and B
    const peerConnection = new RTCPeerConnection(config);

    navigator.mediaDevices.getUserMedia({
      audio: false,
      video: true
    })
      .then(function (stream) {
        localVideo.srcObject = stream;

        peerConnection.addStream(stream);
        peerConnection.createOffer()
          .then(function (sdp) {
            peerConnection.setLocalDescription(sdp);
          })
          .then(function () {
            socket.emit('offer', peerConnection.localDescription);
          });
      });

    // for browser B
    socket.on('answer', function (message) {
      peerConnection.setRemoteDescription(message);
    });

    // for browser B
    socket.on('offer', function (message) {
      peerConnection.setRemoteDescription(message)
        .then(function () {
          peerConnection.createAnswer();
        })
        .then(function (sdp) {
          peerConnection.setLocalDescription(sdp);
        })
        .then(function () {
          socket.emit('answer', peerConnection.localDescription);
        });
    });
    
    socket.on('candidate', function (candidate) {
      const c = new RTCIceCandidate(candidate);

      peerConnection.addIceCandidate(c);
    });

    peerConnection.onaddstream = function (event) {
      remoteVideo.srcObject = event.stream;
    };

    peerConnection.onicecandidate = function (event) {
      if (event.candidate) {
        socket.emit('candidate', event.candidate);
      }
    };

  </script>
</body>
</html>
